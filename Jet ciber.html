<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jet Cyber Mobile — FIXED</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;background:black;overflow:hidden;font-family:'Orbitron',monospace;color:#00ffff}
    canvas{display:block;background:linear-gradient(to bottom,#0a001a,#310045)}
    #hud,#gameOver,#menu,#controls,#fire,#introScreen,#pauseBtn{position:absolute;z-index:10;color:#00ffff;font-size:18px}
    #hud{top:10px;left:10px}
    #gameOver{top:50%;left:50%;transform:translate(-50%,-50%);color:#ff0066;font-size:32px;display:none;text-align:center;z-index:20}
    #restartBtn{margin-top:12px;padding:8px 20px;background:#ff00ff;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .btn{background:rgba(255,255,255,0.03);border:2px solid #00ffff;border-radius:50%;width:56px;height:56px;text-align:center;line-height:56px;color:#00ffff;font-size:18px;user-select:none;touch-action:none}
    #controls{bottom:200px;left:18px}
    #btn-up{position:absolute;top:-64px;left:60px}
    #btn-down{position:absolute;top:72px;left:60px}
    #btn-left{position:absolute;top:0;left:-10px}
    #btn-right{position:absolute;top:0;left:130px}
    #fire{bottom:140px;right:30px;width:78px;height:78px;border-radius:50%;font-size:16px;font-weight:bold;color:#fff;background:#ff00ff;border:none;z-index:20;box-shadow:0 0 12px #ff00ff;touch-action:none}
    #menu{top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:100}
    #menu button{margin:8px;padding:10px 18px;font-size:18px;background:#111;color:#0ff;border:2px solid #0ff;border-radius:8px;cursor:pointer}
    #introScreen{top:0;left:0;width:100%;height:100%;background:black;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:999}
    #introText{font-size:26px;color:#00ffff;animation:fadeInOut 3s ease-in-out}
    @keyframes fadeInOut{0%{opacity:0}25%{opacity:1}75%{opacity:1}100%{opacity:0}}
    #pauseBtn{top:10px;right:10px;background:rgba(0,0,0,0.5);padding:8px 12px;border-radius:8px;border:2px solid #00ffff;cursor:pointer}
    #fullscreenBtn{top:50px;right:10px;background:rgba(0,0,0,0.5);padding:8px 12px;border-radius:8px;border:2px solid #00ffff;cursor:pointer}
    @media (max-width:600px){#hud{font-size:16px}#introText{font-size:20px}}
  </style>
</head>
<body>
  <div id="introScreen"><div id="introText">Class 7E Presents<br>ANR STUDIO™</div></div>

  <div id="hud">
    Score: <span id="score">0</span> |
    High Score: <span id="highscore">0</span><br>
    Peluru: <span id="ammo">20</span>/20<br>
    Level: <span id="level">1</span>
  </div>

  <div id="gameOver">
     GAME OVER <br>
    <button id="restartBtn">Main Lagi</button>
  </div>

  <div id="menu">
    <button id="btnContinue">Lanjutkan</button><br>
    <button id="btnNew">Main Baru</button><br>
    <button id="btnReset">Reset Game</button>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="controls">
    <div class="btn" id="btn-up">↑</div>
    <div class="btn" id="btn-down">↓</div>
    <div class="btn" id="btn-left">←</div>
    <div class="btn" id="btn-right">→</div>
  </div>

  <button id="fire">FIRE</button>
  <button id="pauseBtn">⏸️Pause</button>
  <button id="fullscreenBtn">⤢ Fullscreen</button>

<script>
/* ===== Configuration & State ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreDisplay = document.getElementById('score');
const highScoreDisplay = document.getElementById('highscore');
const ammoDisplay = document.getElementById('ammo');
const levelDisplay = document.getElementById('level');
const gameOverDisplay = document.getElementById('gameOver');
const restartBtn = document.getElementById('restartBtn');
const menu = document.getElementById('menu');

let jet, bullets, enemies, particles, keys;
let score=0, highScore=0, level=1, ammo=20;
let isGameOver=false, isPaused=false;
let animationFrameId=null, spawnIntervalId=null, gameRunning=false;
const MAX_ENEMIES = 20;
const MAX_PARTICLES = 2000;
const MAX_BULLETS = 30;
const SHOOT_COOLDOWN = 150; // ms
let lastShotTime = 0;

/* localStorage keys used (only these will be removed by reset) */
const LS_KEYS = ['anr_score','anr_highscore','anr_level','anr_ammo'];

/* ===== Helpers ===== */
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  // Clamp jet inside visible area if exists
  if (jet){
    jet.y = Math.max(0, Math.min(jet.y, canvas.height - jet.height));
    jet.x = Math.max(0, Math.min(jet.x, canvas.width - jet.width));
  }
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function clamp(val, a, b){ return Math.max(a, Math.min(b, val)); }

function storageAvailable(){
  try {
    const test = '__anr_test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch(e){ return false; }
}

/* ===== Game Init / Save / Load / Clear ===== */
function initGame(resetProgress=true){
  // If continue (resetProgress=false), keep loaded score/level/ammo; otherwise set defaults
  if (resetProgress){
    score = 0; level = 1; ammo = 20;
  }
  jet = { x: 100, y: canvas.height/2 - 20, width: 50, height: 25, color: "#ff00ff", speed: 7 };
  bullets = [];
  enemies = [];
  particles = [];
  keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };
  isGameOver = false;
  isPaused = false;
  scoreDisplay.textContent = score;
  ammoDisplay.textContent = ammo;
  levelDisplay.textContent = level;
  gameOverDisplay.style.display = 'none';
}

function saveGameState(){
  if (!storageAvailable() || isGameOver) return;
  try {
    localStorage.setItem('anr_score', String(score));
    localStorage.setItem('anr_highscore', String(highScore));
    localStorage.setItem('anr_level', String(level));
    localStorage.setItem('anr_ammo', String(ammo));
  } catch(e){ /* ignore */ }
}

function loadGameState(){
  if (!storageAvailable()) return;
  score = parseInt(localStorage.getItem('anr_score')) || 0;
  highScore = parseInt(localStorage.getItem('anr_highscore')) || 0;
  level = parseInt(localStorage.getItem('anr_level')) || 1;
  ammo = parseInt(localStorage.getItem('anr_ammo')) || 20;
  // update HUD, but don't overwrite initGame's jet position etc.
  scoreDisplay.textContent = score;
  highScoreDisplay.textContent = highScore;
  ammoDisplay.textContent = ammo;
  levelDisplay.textContent = level;
}

function clearGameState(){
  if (!storageAvailable()) return;
  for (const k of LS_KEYS) localStorage.removeItem(k);
  // reload to reset UI & variables
  location.reload();
}

/* ===== Spawn / Entities ===== */
function spawnEnemy(){
  if (isGameOver || isPaused) return;
  if (enemies.length >= MAX_ENEMIES) return;
  const size = 30 + Math.random()*30;
  const y = Math.random() * Math.max(1, (canvas.height - size));
  const speed = 3 + Math.random()*2 + Math.floor(level/3);
  enemies.push({ x: canvas.width + 50, y: y, width: size, height: size, color: "#ff3300", speed: speed });
}

/* ===== Shooting & Controls ===== */
function shoot(){
  if (isGameOver || isPaused) return;
  const now = performance.now();
  if (now - lastShotTime < SHOOT_COOLDOWN) return; // debounce fire
  lastShotTime = now;
  if (ammo <= 0) { ammo = 0; ammoDisplay.textContent = ammo; return; }
  if (bullets.length >= MAX_BULLETS) return;
  bullets.push({ x: jet.x + jet.width, y: jet.y + jet.height/2 - 3, width: 20, height: 6, color:"#00ffff", speed: 12 });
  ammo--;
  ammoDisplay.textContent = ammo;
}

/* ===== Explosion Particles ===== */
function createExplosion(x,y){
  const count = Math.min(20, Math.max(6, Math.floor(20 - level/2)));
  for (let i=0;i<count;i++){
    if (particles.length >= MAX_PARTICLES) break;
    particles.push({
      x:x, y:y,
      dx:(Math.random()-0.5)*6,
      dy:(Math.random()-0.5)*6,
      life: 30 + Math.floor(Math.random()*20),
      color: "#ffff00"
    });
  }
}

/* ===== Game Loop ===== */
function update(dt){
  // Movement
  if (keys.ArrowUp && jet.y > 0) jet.y -= jet.speed;
  if (keys.ArrowDown && jet.y + jet.height < canvas.height) jet.y += jet.speed;
  if (keys.ArrowLeft && jet.x > 0) jet.x -= jet.speed;
  if (keys.ArrowRight && jet.x + jet.width < canvas.width) jet.x += jet.speed;

  // Bullets movement & cleanup
  for (let b of bullets) b.x += b.speed;
  bullets = bullets.filter(b => b.x < canvas.width + 50);

  // Enemies movement & cleanup
  for (let e of enemies) e.x -= e.speed;
  enemies = enemies.filter(e => e.x + e.width > -50);

  // Particles
  for (let p of particles){ p.x += p.dx; p.y += p.dy; p.life--; }
  particles = particles.filter(p => p.life > 0);

  // Collisions: jet vs enemies
  for (let i = enemies.length - 1; i >= 0; i--){
    const e = enemies[i];
    if (jet.x < e.x + e.width && jet.x + jet.width > e.x &&
        jet.y < e.y + e.height && jet.y + jet.height > e.y){
      // collision -> game over
      endGame();
      return;
    }
    // bullets vs enemy
    for (let j = bullets.length - 1; j >= 0; j--){
      const b = bullets[j];
      if (b.x < e.x + e.width && b.x + b.width > e.x &&
          b.y < e.y + e.height && b.y + b.height > e.y){
        createExplosion(e.x + e.width/2, e.y + e.height/2);
        enemies.splice(i,1);
        bullets.splice(j,1);
        score += 10;
        scoreDisplay.textContent = score;
        if (score > highScore){ highScore = score; highScoreDisplay.textContent = highScore; }
        // Level up every 100 points (example)
        const newLevel = Math.floor(score / 100) + 1;
        if (newLevel !== level){
          level = newLevel;
          levelDisplay.textContent = level;
        }
        break;
      }
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw jet (simple triangle)
  ctx.fillStyle = jet.color;
  ctx.beginPath();
  ctx.moveTo(jet.x, jet.y + jet.height/2);
  ctx.lineTo(jet.x + jet.width, jet.y);
  ctx.lineTo(jet.x + jet.width, jet.y + jet.height);
  ctx.closePath();
  ctx.fill();

  // bullets
  for (let b of bullets){ ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.width, b.height); }

  // enemies
  for (let e of enemies){ ctx.fillStyle = e.color; ctx.fillRect(e.x, e.y, e.width, e.height); }

  // particles
  for (let p of particles){ ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 3, 3); }
}

let lastTime = 0;
function loop(time){
  if (!gameRunning) return; // prevents double-loop
  if (isPaused || isGameOver){ animationFrameId = requestAnimationFrame(loop); return; }
  const dt = time - (lastTime || time);
  lastTime = time;
  update(dt);
  draw();
  saveGameState();
  animationFrameId = requestAnimationFrame(loop);
}

/* ===== Game Start / Stop / Pause ===== */
function startGame(newGame=true){
  if (gameRunning) stopGame(); // ensure clean
  if (newGame){
    initGame(true);
  } else {
    loadGameState();
    initGame(false);
  }
  // start spawn interval & loop
  spawnIntervalId = setInterval(spawnEnemy, 1000);
  gameRunning = true;
  lastTime = 0;
  animationFrameId = requestAnimationFrame(loop);
}

function stopGame(){
  gameRunning = false;
  if (animationFrameId) cancelAnimationFrame(animationFrameId);
  animationFrameId = null;
  if (spawnIntervalId) { clearInterval(spawnIntervalId); spawnIntervalId = null; }
}

function endGame(){
  isGameOver = true;
  gameOverDisplay.style.display = 'block';
  stopGame();
  saveGameState();
}

function togglePause(){
  if (isGameOver) return;
  isPaused = !isPaused;
  document.getElementById('pauseBtn').textContent = isPaused ? '▶ Resume' : '⏸ Pause';
  if (!isPaused && gameRunning && !animationFrameId){
    animationFrameId = requestAnimationFrame(loop);
  }
}

/* ===== Events ===== */
// Keyboard
window.addEventListener('keydown', e => {
  if (e.key === ' '){ e.preventDefault(); shoot(); return; }
  keys[e.key] = true;
});
window.addEventListener('keyup', e => { keys[e.key] = false; });

// Touch / pointer buttons
const touchButtons = [
  { id: 'btn-up', key: 'ArrowUp' },
  { id: 'btn-down', key: 'ArrowDown' },
  { id: 'btn-left', key: 'ArrowLeft' },
  { id: 'btn-right', key: 'ArrowRight' }
];
touchButtons.forEach(btn=>{
  const el = document.getElementById(btn.id);
  el.addEventListener('pointerdown', ()=> keys[btn.key] = true);
  el.addEventListener('pointerup', ()=> keys[btn.key] = false);
  el.addEventListener('pointerleave', ()=> keys[btn.key] = false);
  el.addEventListener('pointercancel', ()=> keys[btn.key] = false);
});
document.getElementById('fire').addEventListener('pointerdown', shoot);

// Buttons
restartBtn.onclick = ()=> { startGame(true); toggleControls(true); };
document.getElementById('btnContinue').onclick = ()=>{
  menu.style.display = 'none';
  toggleControls(true);
  // load then start without resetting progress
  startGame(false);
};
document.getElementById('btnNew').onclick = ()=>{
  menu.style.display = 'none';
  toggleControls(true);
  // remove saved progress for fresh start
  for (const k of LS_KEYS) localStorage.removeItem(k);
  startGame(true);
};
document.getElementById('btnReset').onclick = ()=> clearGameState();

document.getElementById('pauseBtn').onclick = ()=> togglePause();
document.getElementById('fullscreenBtn').onclick = ()=>{
  if (!document.fullscreenElement) canvas.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
};

/* Pause on tab change */
document.addEventListener('visibilitychange', ()=>{
  if (document.hidden){
    // auto-pause
    if (!isPaused) { isPaused = true; document.getElementById('pauseBtn').textContent = '▶ Resume'; }
  }
});

/* Prevent multiple spawn intervals if startGame called repeatedly */
function toggleControls(show){
  const display = show ? 'block' : 'none';
  document.getElementById('controls').style.display = display;
  document.getElementById('fire').style.display = display;
  document.getElementById('pauseBtn').style.display = display;
  document.getElementById('fullscreenBtn').style.display = display;
}

/* Keep jet in bounds when resize */
window.addEventListener('resize', ()=>{
  if (!jet) return;
  jet.x = clamp(jet.x, 0, canvas.width - jet.width);
  jet.y = clamp(jet.y, 0, canvas.height - jet.height);
});

/* Prevent touch scroll */
document.body.addEventListener('touchstart', e=>{ if (e.target.id === 'gameCanvas' || e.target.id === 'fire') e.preventDefault(); }, {passive:false});

/* ===== Initial setup ===== */
initGame(true);
toggleControls(false); // hide controls at menu
// Show intro for a bit then show menu
setTimeout(()=>{
  document.getElementById('introScreen').style.display = 'none';
  menu.style.display = 'block';
}, 3500);

/* Expose some debug/start shortcuts (works on desktop) */
window.startGame = startGame;
window.stopGame = stopGame;
</script>
</body>
</html>